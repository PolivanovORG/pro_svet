name: Django CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 2
      matrix:
        python-version: ["3.8", "3.12"]

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Установка зависимостей с гибкими версиями для CI
        pip install -r requirements-ci.txt
        
    - name: Check for .env file existence
      run: |
        if [ ! -f .env ]; then
          echo "Creating .env file with test values"
          # Генерируем достаточно длинный и случайный SECRET_KEY для тестов
          SECRET_KEY=$(python -c 'import secrets; print(secrets.token_urlsafe(50))')
          echo "SECRET_KEY=$SECRET_KEY" >> .env
          echo "DEBUG=True" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> .env
        fi
        
    - name: Check for migration issues
      run: |
        # Проверяем, есть ли несохраненные изменения в миграциях
        python manage.py makemigrations --check --dry-run
        if [ $? -ne 0 ]; then
          echo "ERROR: Found uncommitted migration changes!"
          echo "Please run 'python manage.py makemigrations' locally and commit the changes."
          exit 1
        fi
        
    - name: Apply migrations
      run: |
        python manage.py migrate
        
    - name: Run tests
      run: |
        python manage.py test pro_svet.tests --verbosity=2
        
    - name: Check for unused imports and variables
      run: |
        pip install flake8
        # Проверка кода на соответствие стандартам (без выхода с ошибкой)
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exit-zero
        # Проверка сложности кода и длины строк
        flake8 . --count --max-complexity=15 --max-line-length=140 --statistics --exit-zero