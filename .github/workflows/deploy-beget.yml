name: Deploy to Beget via SSH

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to Beget server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.BEGET_HOST }}
        username: ${{ secrets.BEGET_USERNAME }}
        password: ${{ secrets.BEGET_PASSWORD }}
        port: 22
        script: |
          # Подключаемся к серверу и переходим в папку public_html
          cd ${{ secrets.BEGET_DEPLOY_PATH }}
          
          # Удаляем все файлы в папке, включая скрытые
          rm -rf * .* 2>/dev/null || true
          
          # Клонируем репозиторий в текущую папку (точка обязательна)
          git clone https://github.com/PolivanovORG/pro_svet.git .
          
          
          
          # Обновляем права доступа к файлам
          chmod +x manage.py
          
          # Создаем .env файл из .env.example и обновляем ALLOWED_HOSTS
          cp .env.example .env
          # Заменяем ALLOWED_HOSTS в .env файле
          sed -i "s/ALLOWED_HOSTS=.*/ALLOWED_HOSTS=polivajh.beget.tech/" .env

          # Подключаемся к Docker-контейнеру и выполняем команды
          ssh localhost -p222 "
          # Переходим в директорию проекта внутри Docker-контейнера
          cd ${{ secrets.BEGET_DEPLOY_PATH }}

          # Создаем и активируем виртуальное окружение
          python3 -m venv venv
          source venv/bin/activate

          # Устанавливаем зависимости
          pip install --upgrade pip
          pip install -r requirements-ci.txt

          # Выполняем миграции
          python manage.py migrate

          # Собираем статические файлы
          python manage.py collectstatic --noinput

          # Создаем папку tmp и файл restart.txt для перезапуска приложения
          mkdir -p tmp
          touch tmp/restart.txt

          # Выводим информацию о состоянии
          echo 'Deployment completed successfully!'
          echo 'Current directory:'
          pwd
          echo 'Virtual environment packages:'
          pip list
          "